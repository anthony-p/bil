<?/** * Created by JetBrains PhpStorm. * User: Igor * Date: 7/26/13 * Time: 9:20 PM * To change this template use File | Settings | File Templates. */session_start();/*include_once ('includes/npglobal.php');include_once ('includes/npclass_formchecker.php');include_once ('includes/npclass_custom_field.php');include_once ('includes/npclass_item.php');*/include_once ('includes/global.php');/*include_once ('includes/npclass_project_rewards.php');include_once ('includes/npclass_project_updates.php');*/include_once ('includes/npfunctions_login.php');include_once(__DIR__ . '/../language/english/site.lang.php');if (!$session->value('user_id')) {    header_redirect('../login.php');} else {    if ($_POST['add_project_updates'] == true) {        $data['project_id'] = $_POST['project_id'];        $data['comment']    = $_POST['comment'];        $data['user_id']    = $session->value('user_id');        /*        $npProjectUpdates   = new npProjectUpdates();        $npProjectUpdates->insert($data);        $recordId = $npProjectUpdates->getLastComment();*/        $project_updates = $db->rem_special_chars_array($data);        $insert_query = "INSERT INTO project_updates(user_id, project_id, parrent_id, comment, create_at) VALUES";        $insert_query .= "(" .            $project_updates["user_id"] . ", " .            $project_updates["project_id"] . ", '" .            $project_updates["parrent_id"] . "', '" .            $project_updates["comment"] . "', '" .            $currentTime .            "')";        $sql_insert_pitch = $db->query($insert_query);        $recordId = $db->query("SELECT id FROM project_updates ORDER BY id DESC LIMIT 1");        $rowSearched = array();        while ($row = mysql_fetch_array($recordId)) {            $rowSearched = $row;        }        if (!empty($recordId)) {            echo json_encode(array("response" => true, "id" => $rowSearched['id']));        } else {            echo json_encode(array("response" => "error"));        }    } elseif ($_POST['add_project_rewards'] == true) {        $data['project_id'] = $_POST['project_id'];        $data['comment']    = $_POST['comment'];        $data['user_id']    = $session->value('user_id');        /* this function don't work        $npProjectRewards   = new npProjectRewards();        $npProjectRewards->insert($data);        $recordId = $npProjectRewards->getLastComment();        */        $project_rewards = $db->rem_special_chars_array($data);        $insert_query = "INSERT INTO project_rewards(user_id, project_id, parrent_id, comment, create_at) VALUES";        $insert_query .= "(" .            $project_rewards["user_id"] . ", " .            $project_rewards["project_id"] . ", '" .            $project_rewards["parrent_id"] . "', '" .            $project_rewards["comment"] . "', '" .            $currentTime .            "')";        $sql_insert_pitch = $db->query($insert_query);        $recordId = $db->query("SELECT id FROM project_rewards ORDER BY id DESC LIMIT 1");        $rowSearched = array();        while ($row = mysql_fetch_array($recordId)) {            $rowSearched = $row;        }        if (!empty($recordId)) {            echo json_encode(array("response" => true, "id" => $rowSearched['id']));        } else {            echo json_encode(array("response" => "error"));        }	} elseif($_POST['save_project_rewards'] == true){				$compaign_id = isset($_POST["compaign_id"]) ? $_POST["compaign_id"] : '';				if (!empty($compaign_id)) {			$user_id = $session->value('user_id');			$reward_amount = isset($_POST["reward_amount"]) ? $_POST["reward_amount"] : '';			$reward_name = isset($_POST["reward_name"]) ? $_POST["reward_name"] : '';			$reward_description = isset($_POST["reward_description"]) ? $_POST["reward_description"] : '';			$reward_available_number = isset($_POST["reward_available_number"]) ? $_POST["reward_available_number"] : '';			$reward_estimated_delivery_date = isset($_POST["reward_estimated_delivery_date"]) ? $_POST["reward_estimated_delivery_date"] : '';			$reward_shipping_address_required = isset($_POST["reward_shipping_address_required"])  && $_POST['reward_shipping_address_required'] == 'true' ? 1 : 0;					$result = $db->get_sql_number("Select * FROM np_users WHERE user_id='".$compaign_id."' and probid_user_id='".$user_id."'");			if($result == 1){				$db->query("INSERT into project_rewards(user_id, project_id, amount, name, description, available_number, estimated_delivery_date, shipping_address_required) values ('".$user_id."', '".$compaign_id."', '".$reward_amount."', '".$reward_name."', '".$reward_description."', '".$reward_available_number."', FROM_UNIXTIME('".strtotime($reward_estimated_delivery_date)."'), '".$reward_shipping_address_required."')");				$reward_id = mysql_insert_id();				$reward = $db->get_sql_row("SELECT * FROM project_rewards WHERE id=".$reward_id);				echo json_encode(array("response" => addRewardForm($reward)));			} else {				echo json_encode(array("response" => "Access denied"));			}		} else {            echo json_encode(array("response" => "error"));        }	} elseif ($_POST['update_project_rewards'] == true){		$rewardsId = isset($_POST["rewards_id"]) ? $_POST["rewards_id"] : '';				if (!empty($rewardsId)) {			$reward_amount = isset($_POST["reward_amount"]) ? $_POST["reward_amount"] : '';			$reward_name = isset($_POST["reward_name"]) ? $_POST["reward_name"] : '';			$reward_description = isset($_POST["reward_description"]) ? $_POST["reward_description"] : '';			$reward_available_number = isset($_POST["reward_available_number"]) ? $_POST["reward_available_number"] : '';			$reward_estimated_delivery_date = isset($_POST["reward_estimated_delivery_date"]) ? $_POST["reward_estimated_delivery_date"] : '';			$reward_shipping_address_required = isset($_POST["reward_shipping_address_required"])  && $_POST['reward_shipping_address_required'] == 'true' ? 1 : 0;						$result = $db->get_sql_number("Select * FROM project_rewards WHERE id='".$rewardsId."' and user_id='".$session->value('user_id')."'");			if($result == 1){				$db->query("UPDATE project_rewards SET amount='".$reward_amount."', name='".$reward_name."', description='".$reward_description."', available_number='".$reward_available_number."', estimated_delivery_date=FROM_UNIXTIME('".strtotime($reward_estimated_delivery_date)."'), shipping_address_required='".$reward_shipping_address_required."' WHERE id='".$rewardsId."' and user_id='".$session->value('user_id')."'");				echo json_encode(array("response" => true));			} else {				echo json_encode(array("response" => "Access denied"));			}		} else {            echo json_encode(array("response" => "error"));        }    } elseif ($_POST['delete_project_rewards'] == true) {        $rewardsId = isset($_POST["rewards_id"]) ? $_POST["rewards_id"] : '';        if (!empty($rewardsId)) {            /*            $npProjectRewards   = new npProjectRewards();            $npProjectRewards->delete($rewardsId);			*/			$result = $db->get_sql_number("Select * FROM project_rewards WHERE id='".$rewardsId."' and user_id='".$session->value('user_id')."'");			if($result == 1){				$db->query("DELETE FROM project_rewards WHERE id='".$rewardsId."' and user_id='".$session->value('user_id')."'");				echo json_encode(array("response" => true));			} else {				echo json_encode(array("response" => false));			}        } else {            echo json_encode(array("response" => "error"));        }	} elseif($_POST['addNewrewardToProject']) {		$has_new_reward_form = isset($_POST['has_new_reward_form']) && $_POST['has_new_reward_form'] == 'true' ? false : true;				if($has_new_reward_form){			echo json_encode(array("response" => addRewardForm()));		}    } elseif ($_POST['delete_project_updates'] == true) {        $updatesId = $_POST["updates_id"];        if (!empty($updatesId)) {            /*            $npProjectUpdates   = new npProjectUpdates();            $npProjectUpdates->delete($rewardsId);            */            $db->query("DELETE FROM project_updates WHERE id=" . $updatesId);            echo json_encode(array("response" => true));        } else {            echo json_encode(array("response" => "error"));        }    }}